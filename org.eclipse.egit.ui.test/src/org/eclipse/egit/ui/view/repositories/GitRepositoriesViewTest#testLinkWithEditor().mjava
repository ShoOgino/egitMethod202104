	/**
	 * Link with editor, both ways
	 * 
	 * @throws Exception
	 */
	@Test
	public void testLinkWithEditor() throws Exception {
		deleteAllProjects();
		shareProjects(repositoryFile);
		SWTBotPerspective perspective = null;
		try {
			perspective = bot.activePerspective();
			bot.perspectiveById("org.eclipse.ui.resourcePerspective")
					.activate();
			SWTBotTree tree = getOrOpenView().bot().tree();
			myRepoViewUtil.getRootItem(tree, repositoryFile).select();
			// the selection should be root
			assertTrue(tree.selection().get(0, 0).startsWith(REPO1));

			SWTBotView view = bot
					.viewById("org.eclipse.ui.navigator.ProjectExplorer");
			SWTBotTree projectExplorerTree = view.bot().tree();

			SWTBotTreeItem item = getProjectItem(projectExplorerTree, PROJ1)
					.expand().getNode(FOLDER).expand().getNode(FILE1);
			view.show();
			item.doubleClick();

			item = getProjectItem(projectExplorerTree, PROJ1).expand().getNode(
					FOLDER).expand().getNode(FILE2);
			view.show();
			item.doubleClick();
			// now we should have two editors

			// the selection should be still be root
			assertTrue(tree.selection().get(0, 0).startsWith(REPO1));

			// activate the link with selection
			getOrOpenView().toolbarButton("Link with Editor").click();
			bot.editorByTitle(FILE2).show();
			// the selection should have changed to the latest editor
			TestUtil.waitUntilTreeHasSelectedNodeWithText(bot, tree, FILE2, 10000);

			bot.editorByTitle(FILE1).show();
			// selection should have changed
			TestUtil.waitUntilTreeHasSelectedNodeWithText(bot, tree, FILE1, 10000);

			// deactivate the link with editor
			getOrOpenView().toolbarButton("Link with Editor").click();

			bot.editorByTitle(FILE2).show();
			// the selection should be still be test.txt
			TestUtil.waitUntilTreeHasSelectedNodeWithText(bot, tree, FILE1, 10000);

			bot.editorByTitle(FILE1).show();

			myRepoViewUtil.getWorkdirItem(tree, repositoryFile).expand()
					.getNode(PROJ1).expand().getNode(FOLDER).expand().getNode(
							FILE2).select();

			// the editor should still be test.txt
			assertEquals(FILE1, bot.activeEditor().getTitle());

			// activate again
			SWTBotView repoView = getOrOpenView();
			repoView.toolbarButton("Link with Editor").click();
			// make sure focus is here
			// tried to remove this waitInUI but failed.
			// tried setting focus, waiting for focus, joining RepositoriesView
			// refresh job
			waitInUI();
			myRepoViewUtil.getWorkdirItem(tree, repositoryFile).expand()
					.getNode(PROJ1).expand().getNode(FOLDER).expand().getNode(
							FILE2).select();
			TestUtil.waitUntilEditorIsActive(bot, bot.editorByTitle(FILE2), 10000);

			myRepoViewUtil.getWorkdirItem(tree, repositoryFile).expand()
					.getNode(PROJ1).expand().getNode(FOLDER).expand().getNode(
							FILE1).select();
			TestUtil.waitUntilEditorIsActive(bot, bot.editorByTitle(FILE1), 10000);

			// deactivate the link with editor
			getOrOpenView().toolbarButton("Link with Editor").click();

			myRepoViewUtil.getWorkdirItem(tree, repositoryFile).expand()
					.getNode(PROJ1).expand().getNode(FOLDER).expand().getNode(
							FILE2).select();
			TestUtil.waitUntilEditorIsActive(bot, bot.editorByTitle(FILE1), 10000);

		} finally {
			if (perspective != null)
				perspective.activate();
		}
	}

